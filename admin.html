<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Knihovna ƒåerm√°ka a Sta≈àka (v2024.1)</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-black: #1a1a1a;
            --primary-white: #ffffff;
            --gray-light: #f5f5f5;
            --gray-medium: #888888;
            --gray-dark: #333333;
            --accent: #c9a961;
            --success: #27ae60;
            --danger: #e74c3c;
            --warning: #f39c12;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: var(--primary-black);
            background: var(--gray-light);
            padding: 2rem;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--primary-white);
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: var(--primary-black);
            color: var(--primary-white);
            padding: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 300;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-email {
            color: var(--accent);
            font-size: 0.9rem;
        }

        .back-link, .logout-btn {
            color: var(--primary-white);
            text-decoration: none;
            padding: 0.5rem 1rem;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            transition: var(--transition);
            cursor: pointer;
            background: transparent;
            font-size: 0.9rem;
        }

        .back-link:hover, .logout-btn:hover {
            background: var(--primary-white);
            color: var(--primary-black);
        }

        .content {
            padding: 2rem;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 3rem;
        }

        .section {
            background: var(--gray-light);
            padding: 2rem;
            border-radius: 8px;
        }

        .section h2 {
            font-size: 1.5rem;
            font-weight: 400;
            margin-bottom: 1.5rem;
            color: var(--primary-black);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--gray-dark);
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid #e0e0e0;
            border-radius: 4px;
            background: var(--primary-white);
            font-size: 1rem;
            transition: var(--transition);
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(201, 169, 97, 0.1);
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .btn-group {
            display: flex;
            gap: 0.5rem;
        }

        .btn {
            padding: 0.8rem 2rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: var(--transition);
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: var(--accent);
            color: var(--primary-white);
        }

        .btn-primary:hover {
            background: var(--primary-black);
        }

        .btn-danger {
            background: var(--danger);
            color: var(--primary-white);
            padding: 0.4rem 0.8rem;
            font-size: 0.9rem;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .stats {
            grid-column: 1 / -1;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--primary-white);
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid var(--accent);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 300;
            color: var(--accent);
        }

        .stat-label {
            color: var(--gray-medium);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .events-list {
            max-height: 400px;
            overflow-y: auto;
            background: var(--primary-white);
            border-radius: 8px;
            padding: 1rem;
        }

        .event-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid var(--gray-light);
            transition: var(--transition);
        }

        .event-item:hover {
            background: var(--gray-light);
        }

        .event-item:last-child {
            border-bottom: none;
        }

        .event-info h4 {
            font-size: 1.1rem;
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .event-meta {
            color: var(--gray-medium);
            font-size: 0.9rem;
        }

        .subscribers-list {
            max-height: 300px;
            overflow-y: auto;
            background: var(--primary-white);
            border-radius: 8px;
            padding: 1rem;
        }

        .subscriber-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--gray-light);
        }

        .subscriber-item:last-child {
            border-bottom: none;
        }

        .alert {
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
            display: none;
        }

        .alert.show {
            display: block;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        @media (max-width: 768px) {
            .content {
                grid-template-columns: 1fr;
                gap: 2rem;
            }

            .stats {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Login Form -->
    <div id="loginContainer" class="container" style="max-width: 400px; margin-top: 10vh;">
        <div class="header" style="text-align: center;">
            <h1>P≈ôihl√°≈°en√≠ do administrace</h1>
        </div>
        <div style="padding: 2rem;">
            <div class="alert alert-danger" id="loginError"></div>
            <form id="loginForm">
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" name="email" required placeholder="V√°≈° email" autocomplete="username">
                </div>
                <div class="form-group">
                    <label for="password">Heslo</label>
                    <input type="password" id="password" name="password" required placeholder="Va≈°e heslo" autocomplete="current-password">
                </div>
                <button type="submit" class="btn btn-primary" id="loginBtn" style="width: 100%;">P≈ôihl√°sit se</button>
            </form>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="adminContainer" class="container" style="display: none;">
        <div class="header">
            <h1>Administrace Knihovny ƒå&S</h1>
            <div style="display: flex; align-items: center; gap: 1rem;">
                <div class="user-info"></div>
                <a href="knihovna.html" class="back-link">‚Üê Zpƒõt na web</a>
            </div>
        </div>

        <div class="content" id="adminContent">
            <!-- Statistics -->
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="eventCount">0</div>
                    <div class="stat-label">Ud√°lost√≠</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="subscriberCount">0</div>
                    <div class="stat-label">P≈ôihl√°≈°en√≠</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="upcomingCount">0</div>
                    <div class="stat-label">Nadch√°zej√≠c√≠</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="galleryCount">0</div>
                    <div class="stat-label">Fotek v galerii</div>
                </div>
            </div>

            <!-- Add Event Section -->
            <div class="section">
                <h2>P≈ôidat ud√°lost</h2>
                <div class="alert alert-success" id="eventAlert"></div>
                <div class="alert alert-danger" id="eventError"></div>
                
                <form id="eventForm">
                    <div class="form-group">
                        <label>N√°zev ud√°losti *</label>
                        <input type="text" id="eventTitle" required maxlength="100" placeholder="Zadejte n√°zev ud√°losti...">
                    </div>
                    <!-- Typ ud√°losti odstranƒõn pro zjednodu≈°en√≠ -->
                    <div class="form-group">
                        <label>Datum *</label>
                        <input type="date" id="eventDate" required>
                    </div>
                    <div class="form-group">
                        <label>ƒåas *</label>
                        <input type="time" id="eventTime" required>
                    </div>
                    <div class="form-group">
                        <label>Popis ud√°losti *</label>
                        <textarea id="eventDescription" required maxlength="500" placeholder="Popi≈°te ud√°lost, jej√≠ program a dal≈°√≠ d≈Øle≈æit√© informace..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Fotka ud√°losti (URL)</label>
                        <input type="url" id="eventImage" placeholder="https://example.com/image.jpg">
                    </div>
                    <div class="form-group">
                        <label>Link na eshop/vstupenky</label>
                        <input type="url" id="eventShopLink" placeholder="https://obchod.example.com/udalost">
                    </div>
                    <div class="form-group">
                        <label>Text tlaƒç√≠tka (kdy≈æ chyb√≠ link)</label>
                        <input type="text" id="eventButtonText" placeholder="Vstup zdarma" maxlength="50">
                        <small style="color: var(--gray-medium); font-size: 0.8rem;">Nap≈ô: "Vstup zdarma", "Prodej je≈°tƒõ nezah√°jen", "Vyprod√°no" atd.</small>
                    </div>
                    <button type="submit" class="btn btn-primary">P≈ôidat ud√°lost</button>
                </form>
            </div>

            <!-- Manage Events Section -->
            <div class="section">
                <h2>Spr√°va ud√°lost√≠</h2>
                <div class="events-list" id="eventsList">
                    <!-- Events will be populated here -->
                </div>
            </div>

            <!-- Edit Content Section -->
            <div class="section" style="grid-column: 1 / -1;">
                <h2>√öprava obsahu webu</h2>
                <div class="alert alert-success" id="contentAlert"></div>
                <div class="alert alert-danger" id="contentError"></div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
                    <div>
                        <div class="form-group">
                            <label>Hlavn√≠ text "O n√°s"</label>
                            <textarea id="aboutText" rows="4" maxlength="1000" placeholder="Hlavn√≠ popis knihovny..."></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>Popis aktivit</label>
                            <textarea id="aboutDescription" rows="3" maxlength="500" placeholder="Co po≈ô√°d√°te..."></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>Otev√≠rac√≠ doba</label>
                            <textarea id="openingHours" rows="2" maxlength="200" placeholder="Po‚ÄìP√°: 10:00‚Äì21:00<br>So‚ÄìNe: 11:00‚Äì19:00"></textarea>
                        </div>
                    </div>
                    
                    <div>
                        <div class="form-group">
                            <label>Adresa</label>
                            <textarea id="contactAddress" rows="2" maxlength="200" placeholder="Ulice<br>PSƒå Mƒõsto"></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label>Email</label>
                            <input type="email" id="contactEmail" maxlength="100" placeholder="email@knihovna.cz">
                        </div>
                        
                        <div class="form-group">
                            <label>Telefon</label>
                            <input type="tel" id="contactPhone" maxlength="50" placeholder="+420 123 456 789">
                        </div>
                    </div>
                </div>
                
                <button class="btn btn-primary" onclick="saveAllContent()" style="width: 200px; margin-top: 1rem;">Ulo≈æit v≈°e</button>
            </div>

            <!-- Instagram Feed Management -->
            <div class="section">
                <h2>Spr√°va Instagram fotek</h2>
                <div class="alert alert-info">
                    <p>P≈ôidejte fotky, kter√© se zobraz√≠ v Instagram sekci na webu. Ide√°ln√≠ velikost: 300x300px.</p>
                </div>
                <div class="alert alert-danger" id="instagramError" style="display: none;"></div>
                <div class="alert alert-success" id="instagramAlert" style="display: none;"></div>
                
                <form class="form-container" onsubmit="event.preventDefault(); addInstagramPhoto();">
                    <div class="form-group">
                        <label>URL fotky *</label>
                        <input type="url" id="instagramPhotoUrl" placeholder="https://example.com/photo.jpg" required>
                    </div>
                    <div class="form-group">
                        <label>Popisek (nepovinn√Ω)</label>
                        <input type="text" id="instagramPhotoCaption" placeholder="Popisek k fotce..." maxlength="100">
                    </div>
                    <button type="submit" class="btn btn-primary">P≈ôidat Instagram fotku</button>
                </form>
                
                <div class="list-container" id="instagramList">
                    <!-- Instagram photos will be populated here -->
                </div>
            </div>

            <!-- Gallery Management -->
            <div class="section">
                <h2>Spr√°va galerie</h2>
                <div class="alert alert-success" id="galleryAlert"></div>
                <div class="alert alert-danger" id="galleryError"></div>
                
                <div class="form-group">
                    <label>URL obr√°zku</label>
                    <input type="url" id="galleryImageUrl" placeholder="https://example.com/image.jpg">
                </div>
                <div class="form-group">
                    <label>Popis obr√°zku</label>
                    <input type="text" id="galleryImageDescription" placeholder="Popis fotky..." maxlength="100">
                </div>
                <button class="btn btn-primary" onclick="addGalleryImage()" style="margin-bottom: 1rem;">P≈ôidat do galerie</button>
                
                <div class="events-list" id="galleryList">
                    <!-- Gallery items will be populated here -->
                </div>
            </div>

            <!-- Newsletter Subscribers -->
            <!-- Stripe Payment Management -->
            <div class="section">
                <h2>üé´ Spr√°va prodeje vstupenek</h2>
                <div class="alert alert-info">
                    <p>Zde m≈Ø≈æete zapnout/vypnout prodej vstupenek a spravovat typy vstupenek pro jednotliv√© ud√°losti.</p>
                </div>
                <div class="alert alert-success" id="stripeAlert" style="display: none;"></div>
                <div class="alert alert-danger" id="stripeError" style="display: none;"></div>
                
                <!-- Toggle ticket sales -->
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                        <input type="checkbox" id="ticketSalesToggle" onchange="toggleTicketSales()">
                        <strong>Povolit prodej vstupenek (Stripe)</strong>
                    </label>
                    <small style="color: var(--gray-medium);">Zapnƒõte pro aktivaci prodeje vstupenek na webu</small>
                </div>
                
                <!-- Quick test toggle for development -->
                <div class="form-group" style="border: 2px dashed orange; padding: 1rem; border-radius: 8px;">
                    <label style="display: flex; align-items: center; gap: 0.5rem;">
                        <input type="checkbox" id="testTicketSalesToggle" onchange="toggleTestTicketSales()">
                        <strong style="color: orange;">üß™ TEST: Zapnout prodej pro testov√°n√≠ (jen pro aktu√°ln√≠ session)</strong>
                    </label>
                    <small style="color: orange;">Toto je testovac√≠ p≈ôep√≠naƒç - zmƒõny se neukl√°daj√≠ do datab√°ze</small>
                </div>

                <!-- Event selection for ticket management -->
                <div class="form-group">
                    <label for="eventSelectTickets">Vyberte ud√°lost pro spr√°vu vstupenek:</label>
                    <select id="eventSelectTickets" onchange="loadEventTicketTypes()" class="form-control">
                        <option value="">-- Vyberte ud√°lost --</option>
                    </select>
                </div>

                <!-- Ticket types for selected event -->
                <div id="ticketTypesContainer" style="display: none;">
                    <h3>Typy vstupenek</h3>
                    <div id="ticketTypesList"></div>
                    
                    <!-- Add new ticket type -->
                    <div style="border: 2px dashed var(--gray-medium); padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                        <h4>P≈ôidat nov√Ω typ vstupenky</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label for="ticketName">N√°zev</label>
                                <input type="text" id="ticketName" placeholder="nap≈ô. Standardn√≠, VIP, Student" class="form-control">
                            </div>
                            <div class="form-group">
                                <label for="ticketPrice">Cena (Kƒç)</label>
                                <input type="number" id="ticketPrice" placeholder="250" class="form-control" min="0">
                            </div>
                            <div class="form-group">
                                <label for="ticketMaxQuantity">Maxim√°ln√≠ poƒçet</label>
                                <input type="number" id="ticketMaxQuantity" placeholder="50" class="form-control" min="1">
                            </div>
                            <div class="form-group">
                                <label for="ticketDescription">Popis (voliteln√Ω)</label>
                                <input type="text" id="ticketDescription" placeholder="Popis typu vstupenky" class="form-control">
                            </div>
                        </div>
                        <button type="button" onclick="addTicketType()" class="btn btn-primary">P≈ôidat typ vstupenky</button>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>Newsletter - p≈ôihl√°≈°en√≠</h2>
                <div class="subscribers-list" id="subscribersList">
                    <!-- Subscribers will be populated here -->
                </div>
                <button class="btn btn-primary" onclick="exportSubscribers()" style="margin-top: 1rem;">Export CSV</button>
            </div>
        </div>
    </div>

    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://eyfgtagudbvzorrdntdf.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV5Zmd0YWd1ZGJ2em9ycmRudGRmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4MzEwMDMsImV4cCI6MjA3MDQwNzAwM30.uw5k8YWuIzM2Q1e8dzwSKXJBlA_wViVdAvtue6Qx0A0';
        // Admin password no longer used - using Supabase Auth
        
        // Initialize Supabase client with error handling
        let supabase;
        try {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
                auth: {
                    persistSession: false // Disable session to avoid multiple client issues
                }
            });
            console.log('Supabase client initialized successfully');
        } catch (error) {
            console.error('Failed to initialize Supabase client:', error);
        }
        
        // Initialize data
        let events = [];
        let subscribers = [];
        let galleryImages = [];
        let isAuthenticated = false;

        // Utility functions
        function showAlert(type, message, elementId) {
            const alertElement = document.getElementById(elementId);
            alertElement.textContent = message;
            alertElement.className = `alert alert-${type} show`;
            setTimeout(() => {
                alertElement.classList.remove('show');
            }, 5000);
        }

        // Authentication with Supabase
        async function checkAuth() {
            const { data: { session } } = await supabase.auth.getSession();
            
            if (session) {
                isAuthenticated = true;
                showAdminPanel(session.user);
                return true;
            } else {
                isAuthenticated = false;
                showLoginForm();
                return false;
            }
        }
        
        function showLoginForm() {
            document.getElementById('loginContainer').style.display = 'block';
            document.getElementById('adminContainer').style.display = 'none';
            document.getElementById('email').focus();
        }
        
        function showAdminPanel(user) {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('adminContainer').style.display = 'block';
            
            // Update user info in header if needed
            const userInfo = document.querySelector('.user-info');
            if (userInfo) {
                userInfo.innerHTML = `
                    <span class="user-email">${user.email}</span>
                    <button class="logout-btn" onclick="handleLogout()">Odhl√°sit se</button>
                `;
            }
        }
        
        async function handleLogout() {
            if (confirm('Opravdu se chcete odhl√°sit?')) {
                try {
                    await supabase.auth.signOut();
                    isAuthenticated = false;
                    showLoginForm();
                } catch (error) {
                    console.error('Logout error:', error);
                }
            }
        }
        
        // Handle login with Supabase Auth
        async function handleLogin(e) {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const loginBtn = document.getElementById('loginBtn');
            
            loginBtn.disabled = true;
            loginBtn.textContent = 'P≈ôihla≈°ov√°n√≠...';

            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                if (error) {
                    console.error('Login error:', error);
                    showAlert('danger', error.message || 'Nespr√°vn√© p≈ôihla≈°ovac√≠ √∫daje', 'loginError');
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'P≈ôihl√°sit se';
                    return;
                }

                if (data.user) {
                    isAuthenticated = true;
                    showAdminPanel(data.user);
                    await initAdmin();
                }

            } catch (error) {
                console.error('Login error:', error);
                showAlert('danger', 'Chyba p≈ôi p≈ôihla≈°ov√°n√≠. Zkuste to pros√≠m znovu.', 'loginError');
                loginBtn.disabled = false;
                loginBtn.textContent = 'P≈ôihl√°sit se';
            }
        }
        
        document.getElementById('loginForm').addEventListener('submit', handleLogin);
        
        function updateStats() {
            document.getElementById('eventCount').textContent = events.length;
            document.getElementById('subscriberCount').textContent = subscribers.length;
            document.getElementById('galleryCount').textContent = galleryImages.length;
            
            const now = new Date();
            const upcoming = events.filter(event => new Date(event.date + 'T' + event.time) > now);
            document.getElementById('upcomingCount').textContent = upcoming.length;
        }

        // Load data from Supabase
        async function loadEvents() {
            if (!supabase) {
                console.error('Supabase client not initialized');
                return;
            }
            
            try {
                console.log('Loading events from Supabase...');
                const { data, error } = await supabase
                    .from('events')
                    .select('*')
                    .order('date', { ascending: true });
                    
                if (error) {
                    console.error('Supabase error:', error);
                    throw error;
                }
                
                console.log('Events loaded successfully:', data ? data.length : 0, 'events');
                
                // Transform Supabase data to match the format expected by admin panel
                const transformedEvents = (data || []).map(event => ({
                    id: event.id,
                    title: event.title,
                    date: event.date,
                    time: event.time,
                    description: event.description,
                    image: event.image,
                    shopLink: event.shop_link || '',
                    buttonText: event.button_text || ''
                }));
                
                events = transformedEvents;
                renderEvents();
            } catch (error) {
                console.error('Error loading events:', error);
                
                // Fallback to localStorage
                const localEvents = localStorage.getItem('events');
                if (localEvents) {
                    events = JSON.parse(localEvents);
                    renderEvents();
                    console.log('Naƒçteny ud√°losti z localStorage');
                } else {
                    events = [];
                    renderEvents();
                    showAlert('danger', 'Chyba p≈ôi naƒç√≠t√°n√≠ ud√°lost√≠: ' + (error.message || 'Nezn√°m√° chyba'), 'eventError');
                }
            }
        }
        
        async function loadSubscribers() {
            try {
                const { data, error } = await supabase
                    .from('subscribers')
                    .select('*')
                    .order('subscribed_at', { ascending: false });
                    
                if (error) throw error;
                subscribers = data || [];
                renderSubscribers();
            } catch (error) {
                console.error('Error loading subscribers:', error);
            }
        }
        
        function renderEvents() {
            const eventsList = document.getElementById('eventsList');
            
            if (events.length === 0) {
                eventsList.innerHTML = '<p style="text-align: center; color: var(--gray-medium); padding: 2rem;">Zat√≠m nejsou p≈ôidan√© ≈æ√°dn√© ud√°losti</p>';
                return;
            }
            
            // Sort events by date
            const sortedEvents = [...events].sort((a, b) => new Date(a.date + 'T' + a.time) - new Date(b.date + 'T' + b.time));
            
            eventsList.innerHTML = sortedEvents.map(event => {
                const eventDate = new Date(event.date + 'T' + event.time);
                const isUpcoming = eventDate > new Date();
                
                return `
                    <div class="event-item">
                        <div class="event-info">
                            <h4>${event.title} ${isUpcoming ? '' : '<small style="color: var(--gray-medium);">(probƒõhlo)</small>'}</h4>
                            <div class="event-meta">
                                ${new Date(event.date).toLocaleDateString('cs-CZ')} ‚Ä¢ ${event.time.slice(0, 5)}
                            </div>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-primary" onclick="editEvent(${event.id})">Editovat</button>
                            <button class="btn btn-danger" onclick="deleteEvent(${event.id})">Smazat</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderSubscribers() {
            const subscribersList = document.getElementById('subscribersList');
            
            if (subscribers.length === 0) {
                subscribersList.innerHTML = '<p style="text-align: center; color: var(--gray-medium); padding: 2rem;">Zat√≠m se nikdo nep≈ôihl√°sil k newsletteru</p>';
                return;
            }
            
            // Sort by date (newest first)
            const sortedSubscribers = [...subscribers].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            subscribersList.innerHTML = sortedSubscribers.map((subscriber) => `
                <div class="subscriber-item">
                    <div>
                        <strong>${subscriber.email}</strong><br>
                        <small style="color: var(--gray-medium);">
                            P≈ôihl√°≈°en: ${new Date(subscriber.subscribed_at).toLocaleDateString('cs-CZ')} ${new Date(subscriber.subscribed_at).toLocaleTimeString('cs-CZ', {hour: '2-digit', minute: '2-digit'})}
                        </small>
                    </div>
                    <button class="btn btn-danger" onclick="removeSubscriber(${subscriber.id})">Odebrat</button>
                </div>
            `).join('');
        }

        // Event management
        document.getElementById('eventForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!isAuthenticated) return;
            
            const title = document.getElementById('eventTitle').value.trim();
            const type = 'standup'; // V√Ωchoz√≠ typ (pou≈æit√≠ povolen√© hodnoty constraintu)
            const date = document.getElementById('eventDate').value;
            const time = document.getElementById('eventTime').value;
            const description = document.getElementById('eventDescription').value.trim();
            const image = document.getElementById('eventImage').value.trim();
            const shopLink = document.getElementById('eventShopLink').value.trim();
            const buttonText = document.getElementById('eventButtonText').value.trim();
            
            // Validation
            if (!title || !date || !time || !description) {
                showAlert('danger', 'Pros√≠m vypl≈àte v≈°echna povinn√° pole.', 'eventError');
                return;
            }
            
            console.log('Adding event with data:');
            console.log('  title:', title);
            console.log('  type:', type);
            console.log('  date:', date);
            console.log('  time:', time);
            console.log('  description:', description);
            console.log('  image:', image);
            console.log('  shopLink:', shopLink);
            console.log('  buttonText:', buttonText);
            
            // Check if date is not too far in the past
            const eventDate = new Date(date + 'T' + time);
            const now = new Date();
            const daysBefore = (now - eventDate) / (1000 * 60 * 60 * 24);
            
            if (daysBefore > 7) {
                console.log('Event is more than 7 days in past, asking for confirmation');
                if (!confirm('Datum ud√°losti je v√≠ce ne≈æ t√Ωden v minulosti. Chcete pokraƒçovat?')) {
                    console.log('User cancelled old date confirmation');
                    return;
                }
            }
            
            console.log('Proceeding with event save...');
            try {
                const editId = this.dataset.editId;
                console.log('Edit ID:', editId);
                
                if (editId) {
                    console.log('Editing existing event with ID:', editId);
                    // Edit existing event
                    const updateData = {
                        title: title,
                        type: type,
                        date: date,
                        time: time,
                        description: description
                    };
                    
                    // Add all fields (empty values will clear them in database)
                    updateData.image = image;
                    updateData.shop_link = shopLink; 
                    updateData.button_text = buttonText;
                    
                    console.log('Updating Supabase with:');
                    console.log('  updateData:', JSON.stringify(updateData, null, 2));
                    const { error } = await supabase
                        .from('events')
                        .update(updateData)
                        .eq('id', editId);
                        
                    if (error) {
                        console.error('Supabase update failed:', error);
                        showAlert('danger', 'Chyba p≈ôi ukl√°d√°n√≠ do datab√°ze: ' + (error.message || 'Nezn√°m√° chyba'), 'eventError');
                        // Update in localStorage as fallback
                        const eventIndex = events.findIndex(e => e.id == editId);
                        if (eventIndex !== -1) {
                            events[eventIndex] = {
                                id: parseInt(editId),
                                title, type, date, time, description, image,
                                shopLink: shopLink,
                                buttonText: buttonText
                            };
                            localStorage.setItem('events', JSON.stringify(events));
                        }
                    } else {
                        console.log('Event updated in Supabase successfully');
                    }
                    
                    showAlert('success', `Ud√°lost "${title}" byla √∫spƒõ≈°nƒõ aktualizov√°na!`, 'eventAlert');
                    cancelEdit(); // Reset form to add mode
                    
                } else {
                    console.log('Creating new event (not editing)');
                    // Create new event
                    const newEvent = {
                        id: Date.now(),
                        title: title,
                        type: type,
                        date: date,
                        time: time,
                        description: description,
                        image: image,
                        shopLink: shopLink
                    };
                    
                    // Try to save to Supabase first (basic fields only until schema is fixed)
                    const eventData = {
                        title: title,
                        type: type,
                        date: date,
                        time: time,
                        description: description
                    };
                    
                    // Add all fields (empty values will be stored as NULL)
                    eventData.image = image;
                    eventData.shop_link = shopLink;
                    eventData.button_text = buttonText;
                    
                    console.log('Saving to Supabase:', eventData);
                    const { data, error } = await supabase
                        .from('events')
                        .insert([eventData]);
                        
                    if (error) {
                        console.error('Supabase save failed:', error);
                        showAlert('danger', 'Chyba p≈ôi ukl√°d√°n√≠ do datab√°ze: ' + (error.message || 'Nezn√°m√° chyba'), 'eventError');
                        // Save to localStorage as fallback
                        const newEvent = {
                            id: Date.now(),
                            title: title,
                            type: type,
                            date: date,
                            time: time,
                            description: description,
                            image: image,
                            shopLink: shopLink,
                            buttonText: buttonText
                        };
                        events.push(newEvent);
                        localStorage.setItem('events', JSON.stringify(events));
                    } else {
                        console.log('Event saved to Supabase successfully:', data);
                        // Don't duplicate in localStorage, just reload from Supabase
                    }
                    
                    // Reset form
                    this.reset();
                    
                    showAlert('success', `Ud√°lost "${title}" byla √∫spƒõ≈°nƒõ p≈ôid√°na!`, 'eventAlert');
                }
                
                // Reload data and update UI
                await loadEvents();
                updateStats();
                
            } catch (error) {
                console.error('Error adding event:', error);
                showAlert('danger', 'Chyba p≈ôi p≈ôid√°v√°n√≠ ud√°losti: ' + error.message, 'eventError');
            }
        });

        async function deleteEvent(id) {
            if (!isAuthenticated) return;
            
            const event = events.find(e => e.id === id);
            if (confirm(`Opravdu chcete smazat ud√°lost "${event.title}"?`)) {
                try {
                    // Remove from localStorage first
                    events = events.filter(e => e.id !== id);
                    localStorage.setItem('events', JSON.stringify(events));
                    
                    // Try to remove from Supabase
                    const { error } = await supabase
                        .from('events')
                        .delete()
                        .eq('id', id);
                        
                    if (error) {
                        console.log('Supabase delete failed, but localStorage updated:', error);
                    }
                    
                    await loadEvents();
                    updateStats();
                    showAlert('success', 'Ud√°lost byla smaz√°na.', 'eventAlert');
                    
                } catch (error) {
                    console.error('Error deleting event:', error);
                    showAlert('danger', 'Chyba p≈ôi maz√°n√≠ ud√°losti: ' + error.message, 'eventAlert');
                }
            }
        }

        // Edit existing event
        function editEvent(id) {
            if (!isAuthenticated) return;
            
            const event = events.find(e => e.id === id);
            if (!event) {
                alert('Ud√°lost nebyla nalezena.');
                return;
            }
            
            console.log('Editing event:', JSON.stringify(event, null, 2));
            
            // Populate form with event data
            document.getElementById('eventTitle').value = event.title;
            // eventType field removed
            document.getElementById('eventDate').value = event.date;
            document.getElementById('eventTime').value = event.time;
            document.getElementById('eventDescription').value = event.description;
            document.getElementById('eventImage').value = event.image || '';
            document.getElementById('eventShopLink').value = event.shop_link || event.shopLink || '';
            document.getElementById('eventButtonText').value = event.button_text || event.buttonText || '';
            
            // Change form to edit mode
            const form = document.getElementById('eventForm');
            const submitBtn = form.querySelector('button[type="submit"]');
            submitBtn.textContent = 'Ulo≈æit zmƒõny';
            submitBtn.className = 'btn btn-success';
            
            // Add cancel button if not exists
            let cancelBtn = form.querySelector('.cancel-edit-btn');
            if (!cancelBtn) {
                cancelBtn = document.createElement('button');
                cancelBtn.type = 'button';
                cancelBtn.className = 'btn btn-secondary cancel-edit-btn';
                cancelBtn.textContent = 'Zru≈°it editaci';
                cancelBtn.onclick = cancelEdit;
                submitBtn.parentNode.insertBefore(cancelBtn, submitBtn.nextSibling);
            }
            
            // Store edit ID
            form.dataset.editId = id;
            
            // Scroll to form
            form.scrollIntoView({ behavior: 'smooth' });
        }

        // Cancel edit mode
        function cancelEdit() {
            const form = document.getElementById('eventForm');
            const submitBtn = form.querySelector('button[type="submit"]');
            const cancelBtn = form.querySelector('.cancel-edit-btn');
            
            // Reset form
            form.reset();
            delete form.dataset.editId;
            
            // Reset buttons
            submitBtn.textContent = 'P≈ôidat ud√°lost';
            submitBtn.className = 'btn btn-primary';
            
            if (cancelBtn) {
                cancelBtn.remove();
            }
        }

        // About text management
        function loadAboutText() {
            const savedAboutText = localStorage.getItem('aboutText');
            const aboutTextarea = document.getElementById('aboutText');
            
            if (savedAboutText) {
                aboutTextarea.value = savedAboutText;
            } else {
                // Default text
                aboutTextarea.value = 'Knihovna ƒåerm√°ka a Sta≈àka je nez√°visl√Ω kulturn√≠ prostor v srdci mƒõsta, kter√Ω spojuje milovn√≠ky literatury, umƒõn√≠ a dobr√Ωch rozhovor≈Ø. Vznikli jsme s viz√≠ vytvo≈ôit m√≠sto, kde se prol√≠n√° tradiƒçn√≠ knihovnick√° atmosf√©ra s ≈æivou souƒçasnou kulturou.';
            }
        }

        async function saveAllContent() {
            if (!isAuthenticated || !supabase) return;
            
            const contentData = {
                'about_text': document.getElementById('aboutText').value.trim(),
                'about_description': document.getElementById('aboutDescription').value.trim(),
                'opening_hours': document.getElementById('openingHours').value.trim(),
                'contact_address': document.getElementById('contactAddress').value.trim(),
                'contact_email': document.getElementById('contactEmail').value.trim(),
                'contact_phone': document.getElementById('contactPhone').value.trim()
            };
            
            // Validate required fields
            if (!contentData.about_text || !contentData.contact_email) {
                showAlert('danger', 'Hlavn√≠ text "O n√°s" a email jsou povinn√© √∫daje.', 'contentError');
                return;
            }
            
            // Validate email format
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(contentData.contact_email)) {
                showAlert('danger', 'Zadejte platn√Ω email.', 'contentError');
                return;
            }
            
            try {
                console.log('Saving all content to Supabase...');
                
                // Save each setting
                for (const [key, value] of Object.entries(contentData)) {
                    const { error } = await supabase
                        .from('settings')
                        .upsert({ key: key, value: value }, { onConflict: 'key' });
                        
                    if (error) {
                        console.error(`Error saving ${key}:`, error);
                        throw error;
                    }
                }
                
                showAlert('success', 'V≈°echen obsah byl √∫spƒõ≈°nƒõ ulo≈æen!', 'contentAlert');
                console.log('All content saved successfully');
                
            } catch (error) {
                console.error('Error saving content:', error);
                showAlert('danger', 'Chyba p≈ôi ukl√°d√°n√≠ obsahu: ' + (error.message || 'Nezn√°m√° chyba'), 'contentError');
            }
        }

        // Subscriber management
        async function removeSubscriber(id) {
            if (!isAuthenticated) return;
            
            const subscriber = subscribers.find(s => s.id === id);
            if (confirm(`Opravdu chcete odebrat p≈ôihl√°≈°en√≠ "${subscriber.email}"?`)) {
                try {
                    const { error } = await supabase
                        .from('subscribers')
                        .delete()
                        .eq('id', id);
                        
                    if (error) throw error;
                    
                    await loadSubscribers();
                    updateStats();
                    
                } catch (error) {
                    console.error('Error removing subscriber:', error);
                }
            }
        }

        function exportSubscribers() {
            if (subscribers.length === 0) {
                alert('Nem√°te ≈æ√°dn√© p≈ôihl√°≈°en√© k newsletteru.');
                return;
            }
            
            const csvContent = 'data:text/csv;charset=utf-8,Email,Datum p≈ôihl√°≈°en√≠\n' + 
                subscribers.map(sub => `${sub.email},${new Date(sub.date).toLocaleString('cs-CZ')}`).join('\n');
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement('a');
            link.setAttribute('href', encodedUri);
            link.setAttribute('download', `newsletter-prihlaseni-${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Load all content from Supabase
        async function loadAllContent() {
            try {
                const { data, error } = await supabase
                    .from('settings')
                    .select('*');
                    
                if (error) throw error;
                
                if (data && data.length > 0) {
                    data.forEach(setting => {
                        const element = document.getElementById(setting.key.replace('_', ''));
                        if (element) {
                            element.value = setting.value;
                        } else {
                            // Handle specific mappings
                            switch(setting.key) {
                                case 'about_text':
                                    const aboutText = document.getElementById('aboutText');
                                    if (aboutText) aboutText.value = setting.value;
                                    break;
                                case 'about_description':
                                    const aboutDescription = document.getElementById('aboutDescription');
                                    if (aboutDescription) aboutDescription.value = setting.value;
                                    break;
                                case 'opening_hours':
                                    const openingHours = document.getElementById('openingHours');
                                    if (openingHours) openingHours.value = setting.value;
                                    break;
                                case 'contact_address':
                                    const contactAddress = document.getElementById('contactAddress');
                                    if (contactAddress) contactAddress.value = setting.value;
                                    break;
                                case 'contact_email':
                                    const contactEmail = document.getElementById('contactEmail');
                                    if (contactEmail) contactEmail.value = setting.value;
                                    break;
                                case 'contact_phone':
                                    const contactPhone = document.getElementById('contactPhone');
                                    if (contactPhone) contactPhone.value = setting.value;
                                    break;
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading content:', error);
            }
        }
        
        // Gallery management functions
        async function loadGalleryImages() {
            try {
                const { data, error } = await supabase
                    .from('gallery')
                    .select('*')
                    .order('created_at', { ascending: false });
                    
                if (error) throw error;
                
                galleryImages = data || [];
                localStorage.setItem('galleryImages', JSON.stringify(galleryImages));
                
            } catch (error) {
                console.error('Error loading gallery from Supabase:', error);
                const storedImages = localStorage.getItem('galleryImages');
                if (storedImages) {
                    galleryImages = JSON.parse(storedImages);
                }
            }
            renderGalleryImages();
        }

        function renderGalleryImages() {
            const galleryList = document.getElementById('galleryList');
            
            if (galleryImages.length === 0) {
                galleryList.innerHTML = '<p style="text-align: center; color: var(--gray-medium); padding: 2rem;">Zat√≠m nejsou p≈ôidan√© ≈æ√°dn√© fotky</p>';
                return;
            }
            
            galleryList.innerHTML = galleryImages.map(image => `
                <div class="event-item">
                    <div class="event-info" style="display: flex; align-items: center;">
                        <img src="${image.url}" alt="${image.description}" style="width: 60px; height: 40px; object-fit: cover; border-radius: 4px; margin-right: 1rem;" onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=\\'http://www.w3.org/2000/svg\\' viewBox=\\'0 0 60 40\\'><rect fill=\\'%23e0e0e0\\'/><text x=\\'50%\\' y=\\'50%\\' text-anchor=\\'middle\\' font-size=\\'8\\' fill=\\'%23999\\'>!</text></svg>'">
                        <div>
                            <h4>${image.description}</h4>
                            <div class="event-meta">${new Date(image.date).toLocaleDateString('cs-CZ')}</div>
                        </div>
                    </div>
                    <button class="btn btn-danger" onclick="deleteGalleryImage(${image.id})">Smazat</button>
                </div>
            `).join('');
        }

        async function addGalleryImage() {
            if (!isAuthenticated) return;
            
            const url = document.getElementById('galleryImageUrl').value.trim();
            const description = document.getElementById('galleryImageDescription').value.trim();
            
            if (!url) {
                showAlert('danger', 'Pros√≠m zadejte URL obr√°zku.', 'galleryError');
                return;
            }
            
            if (!url.match(/\.(jpeg|jpg|gif|png|webp)$/i) && !url.includes('unsplash.com') && !url.includes('images.')) {
                if (!confirm('URL nevypad√° jako obr√°zek. Chcete pokraƒçovat?')) {
                    return;
                }
            }
            
            try {
                // Save to Supabase first
                const { data, error } = await supabase
                    .from('gallery')
                    .insert([{
                        url: url,
                        description: description || 'Fotka z klubu'
                    }]);
                    
                if (error) {
                    console.log('Supabase save failed, saving to localStorage:', error);
                    // Fallback to localStorage
                    const newImage = {
                        id: Date.now(),
                        url: url,
                        description: description || 'Fotka z klubu',
                        date: new Date().toISOString()
                    };
                    galleryImages.push(newImage);
                    localStorage.setItem('galleryImages', JSON.stringify(galleryImages));
                } else {
                    console.log('Image saved to Supabase successfully');
                }
                
                // Reset form
                document.getElementById('galleryImageUrl').value = '';
                document.getElementById('galleryImageDescription').value = '';
                
                // Reload data
                await loadGalleryImages();
                updateStats();
                
                showAlert('success', 'Fotka byla √∫spƒõ≈°nƒõ p≈ôid√°na do galerie!', 'galleryAlert');
                
            } catch (error) {
                console.error('Error adding gallery image:', error);
                showAlert('danger', 'Chyba p≈ôi p≈ôid√°v√°n√≠ fotky: ' + error.message, 'galleryError');
            }
        }

        async function deleteGalleryImage(id) {
            if (!isAuthenticated) return;
            
            if (confirm('Opravdu chcete smazat tuto fotku?')) {
                try {
                    // Delete from Supabase first
                    const { error } = await supabase
                        .from('gallery')
                        .delete()
                        .eq('id', id);
                        
                    if (error) {
                        console.log('Supabase delete failed:', error);
                        // Fallback to localStorage
                        galleryImages = galleryImages.filter(img => img.id !== id);
                        localStorage.setItem('galleryImages', JSON.stringify(galleryImages));
                    } else {
                        console.log('Image deleted from Supabase successfully');
                    }
                    
                    // Reload data
                    await loadGalleryImages();
                    updateStats();
                    
                    showAlert('success', 'Fotka byla smaz√°na.', 'galleryAlert');
                    
                } catch (error) {
                    console.error('Error deleting gallery image:', error);
                    showAlert('danger', 'Chyba p≈ôi maz√°n√≠ fotky: ' + error.message, 'galleryError');
                }
            }
        }

        // Instagram photo management functions  
        let instagramPhotos = [];

        async function loadInstagramPhotos() {
            try {
                const { data, error } = await supabase
                    .from('instagram_photos')
                    .select('*')
                    .order('created_at', { ascending: false });
                    
                if (error) {
                    if (error.code === 'PGRST116') {
                        console.log('Instagram photos table does not exist, using empty array');
                        instagramPhotos = [];
                        renderInstagramPhotos();
                        return;
                    }
                    throw error;
                }
                
                instagramPhotos = data || [];
                localStorage.setItem('instagramPhotos', JSON.stringify(instagramPhotos));
                
            } catch (error) {
                console.log('Error loading Instagram photos from Supabase:', error.message);
                const storedPhotos = localStorage.getItem('instagramPhotos');
                if (storedPhotos) {
                    instagramPhotos = JSON.parse(storedPhotos);
                } else {
                    instagramPhotos = [];
                }
            }
            renderInstagramPhotos();
        }

        function renderInstagramPhotos() {
            const instagramList = document.getElementById('instagramList');
            
            if (instagramPhotos.length === 0) {
                instagramList.innerHTML = '<p style="text-align: center; color: var(--gray-medium); padding: 2rem;">Zat√≠m nejsou p≈ôidan√© ≈æ√°dn√© Instagram fotky</p>';
                return;
            }
            
            instagramList.innerHTML = instagramPhotos.map(photo => `
                <div class="event-item">
                    <div class="event-info" style="display: flex; align-items: center;">
                        <img src="${photo.url}" alt="${photo.caption || 'Instagram foto'}" style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px; margin-right: 1rem;" onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=\\'http://www.w3.org/2000/svg\\' viewBox=\\'0 0 60 60\\'><rect fill=\\'%23e0e0e0\\'/><text x=\\'50%\\' y=\\'50%\\' text-anchor=\\'middle\\' font-size=\\'8\\' fill=\\'%23999\\'>!</text></svg>'">
                        <div>
                            <h4>${photo.caption || 'Bez popisku'}</h4>
                            <div class="event-meta">${new Date(photo.created_at).toLocaleDateString('cs-CZ')}</div>
                        </div>
                    </div>
                    <button class="btn btn-danger" onclick="deleteInstagramPhoto(${photo.id})">Smazat</button>
                </div>
            `).join('');
        }

        async function addInstagramPhoto() {
            if (!isAuthenticated) return;
            
            const url = document.getElementById('instagramPhotoUrl').value.trim();
            const caption = document.getElementById('instagramPhotoCaption').value.trim();
            
            if (!url) {
                showAlert('danger', 'URL fotky je povinn√Ω!', 'instagramError');
                return;
            }

            try {
                const newPhoto = {
                    url: url,
                    caption: caption || null,
                    created_at: new Date().toISOString()
                };

                // Try to add to Supabase first
                const { data, error } = await supabase
                    .from('instagram_photos')
                    .insert([newPhoto])
                    .select()
                    .single();
                    
                if (error) {
                    console.log('Supabase insert failed:', error);
                    // Fallback to localStorage
                    newPhoto.id = Date.now();
                    instagramPhotos.unshift(newPhoto);
                    localStorage.setItem('instagramPhotos', JSON.stringify(instagramPhotos));
                } else {
                    console.log('Photo added to Supabase successfully');
                }
                
                // Clear form
                document.getElementById('instagramPhotoUrl').value = '';
                document.getElementById('instagramPhotoCaption').value = '';
                
                // Reload data
                await loadInstagramPhotos();
                updateStats();
                
                showAlert('success', 'Instagram fotka byla p≈ôid√°na!', 'instagramAlert');
                
            } catch (error) {
                console.error('Error adding Instagram photo:', error);
                showAlert('danger', 'Chyba p≈ôi p≈ôid√°v√°n√≠ fotky: ' + error.message, 'instagramError');
            }
        }

        async function deleteInstagramPhoto(id) {
            if (!isAuthenticated) return;
            
            if (confirm('Opravdu chcete smazat tuto Instagram fotku?')) {
                try {
                    // Delete from Supabase first
                    const { error } = await supabase
                        .from('instagram_photos')
                        .delete()
                        .eq('id', id);
                        
                    if (error) {
                        console.log('Supabase delete failed:', error);
                        // Fallback to localStorage
                        instagramPhotos = instagramPhotos.filter(photo => photo.id !== id);
                        localStorage.setItem('instagramPhotos', JSON.stringify(instagramPhotos));
                    } else {
                        console.log('Photo deleted from Supabase successfully');
                    }
                    
                    // Reload data
                    await loadInstagramPhotos();
                    updateStats();
                    
                    showAlert('success', 'Instagram fotka byla smaz√°na.', 'instagramAlert');
                    
                } catch (error) {
                    console.error('Error deleting Instagram photo:', error);
                    showAlert('danger', 'Chyba p≈ôi maz√°n√≠ fotky: ' + error.message, 'instagramError');
                }
            }
        }

        // Initialize admin panel
        async function initAdmin() {
            // Set minimum date to today for new events
            document.getElementById('eventDate').min = new Date().toISOString().split('T')[0];
            
            await loadAllContent();
            await loadEvents();
            await loadSubscribers();
            loadGalleryImages();
            await loadInstagramPhotos();
            await initStripeManagement();
            updateStats();
        }

        // Test Supabase connection
        async function testSupabaseConnection() {
            if (!supabase) {
                console.error('Supabase client not available');
                return false;
            }
            
            try {
                console.log('Testing Supabase connection...');
                const { data, error } = await supabase
                    .from('events')
                    .select('count')
                    .limit(1);
                    
                if (error) {
                    console.error('Connection test failed:', error);
                    return false;
                }
                
                console.log('Supabase connection successful');
                return true;
            } catch (error) {
                console.error('Connection test error:', error);
                return false;
            }
        }
        
        // Stripe ticket management functions
        async function initStripeManagement() {
            // Load current ticket sales status
            await loadTicketSalesStatus();
            
            // Populate event select for ticket management
            await populateEventSelectForTickets();
        }
        
        async function loadTicketSalesStatus() {
            try {
                const { data, error } = await supabase
                    .from('settings')
                    .select('*')
                    .eq('key', 'ticket_sales_enabled');
                    
                const ticketSalesToggle = document.getElementById('ticketSalesToggle');
                if (error) {
                    console.log('Settings table error:', error);
                    ticketSalesToggle.checked = false;
                    return;
                }
                
                if (data && data.length > 0) {
                    ticketSalesToggle.checked = data[0].value === 'true';
                } else {
                    ticketSalesToggle.checked = false;
                }
            } catch (error) {
                console.log('Ticket sales status not found, defaulting to disabled:', error);
                document.getElementById('ticketSalesToggle').checked = false;
            }
        }
        
        async function toggleTicketSales() {
            if (!isAuthenticated) return;
            
            const isEnabled = document.getElementById('ticketSalesToggle').checked;
            console.log('Toggling ticket sales to:', isEnabled);
            
            try {
                const { data, error } = await supabase
                    .from('settings')
                    .upsert([{
                        key: 'ticket_sales_enabled',
                        value: isEnabled.toString()
                    }], {
                        onConflict: 'key'
                    })
                    .select();
                
                if (error) {
                    console.error('Supabase upsert error:', error);
                    throw error;
                }
                
                console.log('Settings upserted successfully:', data);
                
                showAlert('success', `Prodej vstupenek byl ${isEnabled ? 'zapnut' : 'vypnut'}.`, 'stripeAlert');
                
                // Inform user about refresh needed
                if (isEnabled) {
                    showAlert('success', 'Prodej vstupenek je aktivn√≠! Obnovte hlavn√≠ str√°nku (F5) aby se zmƒõna projevila.', 'stripeAlert');
                } else {
                    showAlert('success', 'Prodej vstupenek je vypnut. Obnovte hlavn√≠ str√°nku (F5) aby se zmƒõna projevila.', 'stripeAlert');
                }
                
            } catch (error) {
                console.error('Error toggling ticket sales:', error);
                showAlert('danger', 'Chyba p≈ôi zmƒõnƒõ nastaven√≠: ' + error.message, 'stripeError');
                // Revert checkbox
                document.getElementById('ticketSalesToggle').checked = !isEnabled;
            }
        }
        
        // Test toggle that bypasses database - for development/testing
        function toggleTestTicketSales() {
            const isEnabled = document.getElementById('testTicketSalesToggle').checked;
            console.log('Test toggle - setting ticket sales to:', isEnabled);
            
            // Save to localStorage for main page to read
            localStorage.setItem('test_ticket_sales_enabled', isEnabled.toString());
            
            if (isEnabled) {
                showAlert('success', 'üß™ TEST: Prodej vstupenek je doƒçasnƒõ zapnut! Obnovte hlavn√≠ str√°nku (F5) pro testov√°n√≠.', 'stripeAlert');
            } else {
                showAlert('success', 'üß™ TEST: Prodej vstupenek je vypnut.', 'stripeAlert');
            }
        }
        
        async function populateEventSelectForTickets() {
            const select = document.getElementById('eventSelectTickets');
            select.innerHTML = '<option value="">-- Vyberte ud√°lost --</option>';
            
            events.forEach(event => {
                const option = document.createElement('option');
                option.value = event.id;
                const eventDate = new Date(event.date).toLocaleDateString('cs-CZ');
                option.textContent = `${event.title} (${eventDate})`;
                select.appendChild(option);
            });
        }
        
        async function loadEventTicketTypes() {
            const eventId = document.getElementById('eventSelectTickets').value;
            const container = document.getElementById('ticketTypesContainer');
            const listContainer = document.getElementById('ticketTypesList');
            
            if (!eventId) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            
            try {
                const { data: ticketTypes, error } = await supabase
                    .from('ticket_types')
                    .select('*')
                    .eq('event_id', eventId)
                    .order('price', { ascending: true });
                
                if (error) throw error;
                
                if (!ticketTypes || ticketTypes.length === 0) {
                    listContainer.innerHTML = '<p style="color: var(--gray-medium); font-style: italic;">≈Ω√°dn√© typy vstupenek pro tuto ud√°lost.</p>';
                    return;
                }
                
                listContainer.innerHTML = ticketTypes.map(ticket => `
                    <div style="border: 1px solid var(--gray-medium); border-radius: 8px; padding: 1rem; margin-bottom: 1rem; background: white;">
                        <div style="display: flex; justify-content: between; align-items: start;">
                            <div style="flex: 1;">
                                <h4 style="margin: 0 0 0.5rem 0; color: var(--primary-black);">${ticket.name}</h4>
                                ${ticket.description ? `<p style="margin: 0 0 0.5rem 0; color: var(--gray-medium); font-size: 0.9rem;">${ticket.description}</p>` : ''}
                                <p style="margin: 0; font-weight: bold; color: var(--accent);">${(ticket.price / 100).toFixed(0)} Kƒç</p>
                                <p style="margin: 0.25rem 0 0 0; font-size: 0.9rem; color: var(--gray-medium);">
                                    Max: ${ticket.max_quantity} ks | Prod√°no: ${ticket.sold_quantity || 0} ks | 
                                    Status: ${ticket.is_active ? 'Aktivn√≠' : 'Neaktivn√≠'}
                                </p>
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button onclick="toggleTicketType('${ticket.id}', ${!ticket.is_active})" class="btn ${ticket.is_active ? 'btn-warning' : 'btn-success'}" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">
                                    ${ticket.is_active ? 'Deaktivovat' : 'Aktivovat'}
                                </button>
                                <button onclick="deleteTicketType('${ticket.id}')" class="btn btn-danger" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">
                                    Smazat
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Error loading ticket types:', error);
                showAlert('danger', 'Chyba p≈ôi naƒç√≠t√°n√≠ typ≈Ø vstupenek: ' + error.message, 'stripeError');
                listContainer.innerHTML = '<p style="color: var(--danger);">Chyba p≈ôi naƒç√≠t√°n√≠ typ≈Ø vstupenek.</p>';
            }
        }
        
        async function addTicketType() {
            if (!isAuthenticated) return;
            
            const eventId = document.getElementById('eventSelectTickets').value;
            const name = document.getElementById('ticketName').value.trim();
            const price = parseInt(document.getElementById('ticketPrice').value);
            const maxQuantity = parseInt(document.getElementById('ticketMaxQuantity').value);
            const description = document.getElementById('ticketDescription').value.trim();
            
            if (!eventId) {
                showAlert('danger', 'Nejprve vyberte ud√°lost.', 'stripeError');
                return;
            }
            
            if (!name || !price || !maxQuantity) {
                showAlert('danger', 'Vypl≈àte v≈°echna povinn√° pole (n√°zev, cena, max. poƒçet).', 'stripeError');
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('ticket_types')
                    .insert([{
                        event_id: eventId,
                        name: name,
                        price: price * 100, // Convert to cents
                        description: description || null,
                        max_quantity: maxQuantity,
                        sold_quantity: 0,
                        is_active: true
                    }]);
                
                if (error) throw error;
                
                showAlert('success', `Typ vstupenky "${name}" byl √∫spƒõ≈°nƒõ p≈ôid√°n.`, 'stripeAlert');
                
                // Clear form
                document.getElementById('ticketName').value = '';
                document.getElementById('ticketPrice').value = '';
                document.getElementById('ticketMaxQuantity').value = '';
                document.getElementById('ticketDescription').value = '';
                
                // Reload ticket types
                await loadEventTicketTypes();
                
            } catch (error) {
                console.error('Error adding ticket type:', error);
                showAlert('danger', 'Chyba p≈ôi p≈ôid√°v√°n√≠ typu vstupenky: ' + error.message, 'stripeError');
            }
        }
        
        async function toggleTicketType(ticketId, newStatus) {
            if (!isAuthenticated) return;
            
            try {
                const { error } = await supabase
                    .from('ticket_types')
                    .update({ is_active: newStatus })
                    .eq('id', ticketId);
                
                if (error) throw error;
                
                showAlert('success', `Typ vstupenky byl ${newStatus ? 'aktivov√°n' : 'deaktivov√°n'}.`, 'stripeAlert');
                await loadEventTicketTypes();
                
            } catch (error) {
                console.error('Error toggling ticket type:', error);
                showAlert('danger', 'Chyba p≈ôi zmƒõnƒõ stavu: ' + error.message, 'stripeError');
            }
        }
        
        async function deleteTicketType(ticketId) {
            if (!isAuthenticated) return;
            
            if (!confirm('Opravdu chcete smazat tento typ vstupenky? Tato akce je nevratn√°.')) {
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('ticket_types')
                    .delete()
                    .eq('id', ticketId);
                
                if (error) throw error;
                
                showAlert('success', 'Typ vstupenky byl smaz√°n.', 'stripeAlert');
                await loadEventTicketTypes();
                
            } catch (error) {
                console.error('Error deleting ticket type:', error);
                showAlert('danger', 'Chyba p≈ôi maz√°n√≠ typu vstupenky: ' + error.message, 'stripeError');
            }
        }

        // Listen for auth state changes
        supabase.auth.onAuthStateChange((event, session) => {
            if (event === 'SIGNED_OUT') {
                showLoginForm();
            }
        });
        
        // Start the app
        checkAuth();
        
        // Test connection when page loads
        setTimeout(() => {
            testSupabaseConnection();
        }, 1000);
    </script>
</body>
</html>