<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galerie - Knihovna ƒåerm√°ka a Sta≈àka</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Z√°kladn√≠ styly */
        * {
            box-sizing: border-box;
        }
        
        body {
            min-height: 100vh;
            margin: 0;
            background-color: #000;
        }
        
        /* Gallery grid */
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
        }
        
        /* Image hover effect */
        .gallery-item {
            position: relative;
            aspect-ratio: 1;
            overflow: hidden;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        
        .gallery-item:hover {
            transform: scale(1.05);
        }
        
        .gallery-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .gallery-item .overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(transparent, rgba(0,0,0,0.7));
            color: white;
            padding: 1rem;
            transform: translateY(100%);
            transition: transform 0.3s ease;
        }
        
        .gallery-item:hover .overlay {
            transform: translateY(0);
        }
        
        /* Modal styles */
        .modal-image {
            max-width: 90vw;
            max-height: 90vh;
            object-fit: contain;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="bg-black py-4 px-4 sm:px-6 lg:px-8 sticky top-0 z-50 border-b border-gray-800">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <a href="knihovna.html" class="text-white text-xl font-bold hover:text-red-500 transition-colors">‚Üê Zpƒõt na hlavn√≠ str√°nku</a>
            <div class="text-white">
                <span class="font-bold">Knihovna ƒåerm√°ka a Sta≈àka</span>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="bg-gradient-to-b from-gray-900 to-black py-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <h1 class="text-4xl md:text-5xl font-bold text-white text-center mb-4">
                Kompletn√≠ galerie
            </h1>
            <p class="text-xl text-gray-300 text-center max-w-3xl mx-auto">
                Prohl√©dnƒõte si v≈°echny fotky z na≈°ich akc√≠. Zachycujeme nejlep≈°√≠ momenty ze stand-up≈Ø, diskuz√≠, workshop≈Ø a dal≈°√≠ch kulturn√≠ch ud√°lost√≠.
            </p>
        </div>
    </section>

    <!-- Stats Section -->
    <section class="py-8 bg-gray-900">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="text-center">
                <span class="text-gray-300">Celkem fotek: <span id="photoCount" class="font-bold text-white">0</span></span>
                <div class="mt-2">
                    <button id="loadMoreBtn" class="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700 transition-colors font-medium" style="display: none;">
                        Naƒç√≠st dal≈°√≠ fotky
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- Gallery Grid -->
    <section class="py-12 bg-black">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div id="galleryGrid" class="gallery-grid">
                <!-- Photos will be loaded here -->
            </div>
            
            <!-- Loading indicator -->
            <div id="loadingIndicator" class="text-center py-12">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-red-600"></div>
                <p class="text-gray-400 mt-2">Naƒç√≠t√°m fotky...</p>
            </div>
            
            <!-- No photos message -->
            <div id="noPhotosMessage" class="text-center py-12" style="display: none;">
                <p class="text-gray-400 text-lg">≈Ω√°dn√© fotky k zobrazen√≠</p>
            </div>
        </div>
    </section>

    <!-- Photo Modal -->
    <div id="photoModal" class="fixed inset-0 bg-black bg-opacity-90 z-50 flex items-center justify-center p-4" style="display: none;">
        <div class="relative">
            <button onclick="closePhotoModal()" class="absolute top-4 right-4 text-white hover:text-gray-300 z-10 bg-black bg-opacity-50 rounded-full p-2">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
            <img id="modalImage" class="modal-image rounded-lg" src="" alt="">
            <div id="modalCaption" class="absolute bottom-4 left-4 right-4 text-white bg-black bg-opacity-50 p-4 rounded-lg">
                <!-- Caption will be loaded here -->
            </div>
            <!-- Navigation arrows -->
            <button id="prevPhoto" onclick="navigatePhoto(-1)" class="absolute left-4 top-1/2 transform -translate-y-1/2 text-white hover:text-gray-300 bg-black bg-opacity-50 rounded-full p-2">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
            </button>
            <button id="nextPhoto" onclick="navigatePhoto(1)" class="absolute right-4 top-1/2 transform -translate-y-1/2 text-white hover:text-gray-300 bg-black bg-opacity-50 rounded-full p-2">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
            </button>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-black text-white py-8 border-t border-gray-800">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
            <p class="text-gray-400">&copy; 2024 Knihovna ƒåerm√°ka a Sta≈àka. V≈°echna pr√°va vyhrazena.</p>
        </div>
    </footer>

    <!-- Supabase & Scripts -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://eyfgtagudbvzorrdntdf.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImV5Zmd0YWd1ZGJ2em9ycmRudGRmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzMxNjE2MjEsImV4cCI6MjA0ODczNzYyMX0.xNJmWGpDbaVRIKkEPTlHbFSVnMVhWKGYTiXjbpidRSE';
        
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let allPhotos = [];
        let displayedPhotos = [];
        let currentPhotoIndex = 0;
        const PHOTOS_PER_LOAD = 20;

        // Load gallery images
        async function loadGalleryImages() {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const noPhotosMessage = document.getElementById('noPhotosMessage');
            
            try {
                loadingIndicator.style.display = 'block';
                
                const { data, error } = await supabaseClient
                    .from('gallery')
                    .select('*')
                    .order('created_at', { ascending: false });
                    
                if (error) throw error;
                
                allPhotos = data || [];
                console.log(`Loaded ${allPhotos.length} photos from Supabase`);
                
                if (allPhotos.length === 0) {
                    loadingIndicator.style.display = 'none';
                    noPhotosMessage.style.display = 'block';
                    return;
                }
                
                loadMorePhotos();
                
            } catch (error) {
                console.error('Error loading gallery images:', error);
                
                // Try localStorage fallback
                const storedImages = localStorage.getItem('galleryImages');
                if (storedImages) {
                    allPhotos = JSON.parse(storedImages);
                    console.log(`Loaded ${allPhotos.length} photos from localStorage`);
                    loadMorePhotos();
                } else {
                    loadingIndicator.style.display = 'none';
                    noPhotosMessage.style.display = 'block';
                }
            }
        }

        // Load more photos (pagination)
        function loadMorePhotos() {
            const startIndex = displayedPhotos.length;
            const endIndex = Math.min(startIndex + PHOTOS_PER_LOAD, allPhotos.length);
            const newPhotos = allPhotos.slice(startIndex, endIndex);
            
            displayedPhotos = [...displayedPhotos, ...newPhotos];
            renderGallery();
            updatePhotoCount();
            
            const loadingIndicator = document.getElementById('loadingIndicator');
            const loadMoreBtn = document.getElementById('loadMoreBtn');
            
            loadingIndicator.style.display = 'none';
            
            if (displayedPhotos.length < allPhotos.length) {
                loadMoreBtn.style.display = 'inline-block';
            } else {
                loadMoreBtn.style.display = 'none';
            }
        }

        // Helper: Add Cloudinary f_auto transformation for automatic format conversion (HEIC -> JPEG/WebP)
        function getOptimizedUrl(url) {
            if (url && url.includes('cloudinary.com')) {
                return url.replace('/upload/', '/upload/f_auto/');
            }
            return url;
        }

        // Render gallery
        function renderGallery() {
            const galleryGrid = document.getElementById('galleryGrid');

            const newPhotosHtml = displayedPhotos.slice(displayedPhotos.length - PHOTOS_PER_LOAD).map((photo, index) => {
                const actualIndex = displayedPhotos.length - PHOTOS_PER_LOAD + index;
                const date = new Date(photo.created_at || photo.date).toLocaleDateString('cs-CZ');
                const imageUrl = getOptimizedUrl(photo.url);

                return `
                    <div class="gallery-item" onclick="openPhotoModal(${actualIndex})">
                        <img src="${imageUrl}" alt="${photo.description || 'Fotka z knihovny'}" 
                             onerror="this.parentElement.innerHTML='<div class=\\'w-full h-full bg-gray-700 flex items-center justify-center text-gray-400\\'>üì∑<br>Fotka se nenaƒçetla</div>'">
                        <div class="overlay">
                            <p class="text-sm font-medium">${photo.description || 'Fotka z knihovny'}</p>
                            <p class="text-xs text-gray-300">${date}</p>
                        </div>
                    </div>
                `;
            }).join('');
            
            if (displayedPhotos.length <= PHOTOS_PER_LOAD) {
                galleryGrid.innerHTML = newPhotosHtml;
            } else {
                galleryGrid.innerHTML += newPhotosHtml;
            }
        }

        // Update photo count
        function updatePhotoCount() {
            document.getElementById('photoCount').textContent = allPhotos.length;
        }

        // Open photo modal
        function openPhotoModal(index) {
            currentPhotoIndex = index;
            const photo = displayedPhotos[index];
            const imageUrl = getOptimizedUrl(photo.url);

            document.getElementById('modalImage').src = imageUrl;
            document.getElementById('modalImage').alt = photo.description || 'Fotka z knihovny';
            
            const date = new Date(photo.created_at || photo.date).toLocaleDateString('cs-CZ');
            document.getElementById('modalCaption').innerHTML = `
                <h3 class="font-bold">${photo.description || 'Fotka z knihovny'}</h3>
                <p class="text-sm text-gray-300">${date}</p>
            `;
            
            document.getElementById('photoModal').style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        // Close photo modal
        function closePhotoModal() {
            document.getElementById('photoModal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        // Navigate photos in modal
        function navigatePhoto(direction) {
            currentPhotoIndex += direction;
            
            if (currentPhotoIndex >= displayedPhotos.length) {
                currentPhotoIndex = 0;
            } else if (currentPhotoIndex < 0) {
                currentPhotoIndex = displayedPhotos.length - 1;
            }
            
            openPhotoModal(currentPhotoIndex);
        }

        // Load more button handler
        document.getElementById('loadMoreBtn').addEventListener('click', loadMorePhotos);

        // Close modal on background click
        document.getElementById('photoModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closePhotoModal();
            }
        });

        // Keyboard navigation
        document.addEventListener('keydown', function(e) {
            const modal = document.getElementById('photoModal');
            if (modal.style.display === 'flex') {
                if (e.key === 'Escape') {
                    closePhotoModal();
                } else if (e.key === 'ArrowLeft') {
                    navigatePhoto(-1);
                } else if (e.key === 'ArrowRight') {
                    navigatePhoto(1);
                }
            }
        });

        // Initialize
        loadGalleryImages();
        
        // Auto-refresh every 60 seconds
        setInterval(loadGalleryImages, 60000);
    </script>
</body>
</html>